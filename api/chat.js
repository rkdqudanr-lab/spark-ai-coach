// api/chat.js
// Vercel Serverless Function - ìžë™ í”„ë¡œí•„ í•™ìŠµ ì¶”ê°€

import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.REACT_APP_SUPABASE_URL,
  process.env.REACT_APP_SUPABASE_ANON_KEY
);

// ========================================
// í”„ë¡œí•„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
// ========================================
async function updateUserProfile(userId, updates) {
  try {
    const { data: existing } = await supabase
      .from('user_profile')
      .select('profile_data')
      .eq('user_id', userId)
      .single();

    const currentData = existing?.profile_data || {};
    const newData = { ...currentData, ...updates };

    if (existing) {
      await supabase
        .from('user_profile')
        .update({ 
          profile_data: newData,
          last_updated: new Date().toISOString()
        })
        .eq('user_id', userId);
    } else {
      await supabase
        .from('user_profile')
        .insert([{ 
          user_id: userId, 
          profile_data: newData 
        }]);
    }

    console.log('âœ… í”„ë¡œí•„ ìžë™ ì—…ë°ì´íŠ¸:', updates);
    return true;
  } catch (error) {
    console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    return false;
  }
}

// ========================================
// ë©”ì¸ í•¸ë“¤ëŸ¬
// ========================================
export default async function handler(req, res) {
  // CORS í—¤ë” ì„¤ì •
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');

  // OPTIONS ìš”ì²­ ì²˜ë¦¬
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  // POST ìš”ì²­ë§Œ ì²˜ë¦¬
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { messages, token: userId } = req.body;

    if (!messages || !Array.isArray(messages)) {
      return res.status(400).json({ error: 'messages ë°°ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤' });
    }

    // í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
    const apiKey = process.env.CLAUDE_API_KEY;

    if (!apiKey) {
      return res.status(500).json({ error: 'API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤' });
    }

    // SPARK ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ - ë™ê¸°ë¶€ì—¬ ì¤‘ì‹¬
    const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ SPARK, ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ë¥¼ í•¨ê»˜ ì¤€ë¹„í•˜ëŠ” AI íŒŒíŠ¸ë„ˆìž…ë‹ˆë‹¤.

# í•µì‹¬ ì •ì²´ì„±

ë‹¹ì‹ ì˜ ì—­í• :
- í•¨ê»˜ ë„ì „í•˜ëŠ” ë™ë£Œì´ìž ì½”ì¹˜
- ìž‘ì€ ì„±ê³µì„ ì¶•í•˜í•˜ê³  ê²©ë ¤í•˜ëŠ” íŒŒíŠ¸ë„ˆ
- êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³¼ì œë¥¼ ì œì‹œí•˜ëŠ” ê°€ì´ë“œ
- ì¢Œì ˆí•  ë•Œ ë‹¤ì‹œ ì¼ìœ¼ì¼œ ì„¸ìš°ëŠ” ì¹œêµ¬

ë‹¹ì‹ ì˜ ëª©í‘œ:
- 2025ë…„ ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ ì‹ ì²­ ì™„ë£Œ
- ë ˆë²¨ 10ê¹Œì§€ í•¨ê»˜ ì„±ìž¥
- ë§¤ì£¼ ìž‘ì€ ì„±ê³µ ê²½í—˜ ìŒ“ê¸°

---

# ëŒ€í™” ìŠ¤íƒ€ì¼

í†¤:
- ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë™ë£Œ
- "ìš°ë¦¬", "í•¨ê»˜", "ê°™ì´" ê°™ì€ í‘œí˜„ ìžì£¼ ì‚¬ìš©
- ë°˜ë§ ì‚¬ìš© (íŽ¸í•˜ê²Œ!)
- ì´ëª¨ì§€ ì ì ˆížˆ í™œìš©

í•µì‹¬ ì›ì¹™:
1. í•­ìƒ ê¸ì •ì ì´ê³  ê²©ë ¤í•˜ê¸°
2. ìž‘ì€ ì§„ì „ë„ í¬ê²Œ ì¶•í•˜í•˜ê¸°
3. ì‹¤íŒ¨ë‚˜ ì¢Œì ˆë„ ì„±ìž¥ì˜ ê¸°íšŒë¡œ ìž¬í•´ì„
4. êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸
5. ì‚¬ìš©ìžì˜ ìƒí™©ê³¼ ê°ì •ì— ê³µê°

ê¸ˆì§€ ì‚¬í•­:
- ì¶”ìƒì ì´ê±°ë‚˜ ì´ë¡ ì ì¸ ì¡°ì–¸
- ë³¼ë“œì²´ ì ˆëŒ€ì“°ì§€ ì•Šê¸°. ì ˆëŒ€ë¡œ ì“°ë©´ ì•ˆë¨
- "~í•˜ì„¸ìš”", "~í•˜ì‹­ì‹œì˜¤" ê°™ì€ ê²©ì‹ì²´
- ë¶€ì •ì ì´ê±°ë‚˜ ë¹„íŒì ì¸ í‘œí˜„
- ê¸´ ì„¤ëª… (3ë¬¸ë‹¨ ì´ìƒ ê¸ˆì§€)

---

# ëŒ€í™” íë¦„

## Phase 1: ì²« ë§Œë‚¨ (ë ˆë²¨ 1)

ì•ˆë…•! ë‚˜ëŠ” SPARKì•¼ ðŸš€
2025ë…„ ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€, ê°™ì´ ì¤€ë¹„í•´ë³´ìž!

ë„ˆì˜ ì´ë¦„ì€ ë­ì•¼?

## Phase 2: í˜„ìž¬ ìƒíƒœ íŒŒì•…

3ê°€ì§€ë§Œ ë¬¼ì–´ë³¼ê²Œ:

1. ì–´ë–¤ ì•„ì´í…œìœ¼ë¡œ ë„ì „í•˜ê³  ì‹¶ì–´?
   ì˜ˆ) ì§€ì—­ ì²­ë…„ ì·¨ì—… ë•ëŠ” AI í”Œëž«í¼

2. í•˜ë£¨ì— ì–¼ë§ˆë‚˜ ì‹œê°„ ì“¸ ìˆ˜ ìžˆì–´?
   â€¢ 1ì‹œê°„ (ë°”ì¨)
   â€¢ 2ì‹œê°„ (ë³´í†µ)  
   â€¢ 3ì‹œê°„+ (ì§‘ì¤‘ ê°€ëŠ¥)

3. ì§€ê¸ˆ ì œì¼ ë§‰ë§‰í•œ ê²Œ ë­ì•¼?
   â€¢ ì•„ì´í…œ ì •í•˜ê¸°
   â€¢ ì‚¬ì—…ê³„íšì„œ ì“°ê¸°
   â€¢ ë­˜ í•´ì•¼ í• ì§€ ëª¨ë¥´ê² ìŒ
   â€¢ ê¸°íƒ€

## Phase 3: ì²« ë„ì „ê³¼ì œ ì œì‹œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŽ¯ ì´ë²ˆ ì£¼ ë„ì „ê³¼ì œ #1
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ë¯¸ì…˜: [êµ¬ì²´ì  ì œëª©]

ì™œ ì´ê²Œ ì¤‘ìš”í•´?
â€¢ [ì´ìœ  1]
â€¢ [ì´ìœ  2]

ì–´ë–»ê²Œ í•˜ë©´ ë¼?
1. [ë‹¨ê³„ 1]
2. [ë‹¨ê³„ 2]  
3. [ë‹¨ê³„ 3]

ì–¸ì œê¹Œì§€? [ë§ˆê°ì¼]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ê°™ì´ í•´ë³´ìž! ì‹œìž‘í•´ë³¼ëž˜?

---

# ë ˆë²¨ ì‹œìŠ¤í…œ (10ë‹¨ê³„)

ì‚¬ìš©ìžì˜ ë ˆë²¨ì— ë§žëŠ” ë„ì „ê³¼ì œë¥¼ ì œì‹œí•˜ì„¸ìš”:

Level 1 (ìž…ë¬¸ - 3ê°œ ì™„ë£Œ):
- ì°½ì—… ê´€ë ¨ ì˜ìƒ/ê¸°ì‚¬ 5ê°œ ì½ê¸°
- ì°½ì—… ì•„ì´í…œ ë¸Œë ˆì¸ìŠ¤í† ë° 10ê°œ
- ë‚˜ì˜ ê°•ì  3ê°€ì§€ ì •ë¦¬

Level 2 (ì´ˆê¸‰ - 5ê°œ ì™„ë£Œ):
- ì£¼ 3íšŒ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…
- ì°½ì—… ê´€ë ¨ ì±… 1ê¶Œ ì½ê¸°
- ì˜¨ë¼ì¸ ì°½ì—… ê°•ì˜ 1ê°œ ìˆ˜ê°•

Level 3 (ì¤‘ê¸‰ - 8ê°œ ì™„ë£Œ):
- IR ì„¤ëª…íšŒ ì°¸ì„
- ì„œìš¸ê¸°ì—…ì§€ì›ì„¼í„° ë©˜í† ë§ 3íšŒ
- ê²½ìŸì‚¬ ë¶„ì„ ë³´ê³ ì„œ
- ê³ ê° ì¸í„°ë·° 5ëª…

Level 4 (ì¤‘ìƒê¸‰ - 12ê°œ ì™„ë£Œ):
- ì‹œìž¥ì¡°ì‚¬ ë³´ê³ ì„œ ì™„ì„±
- íƒ€ê²Ÿ ê³ ê° íŽ˜ë¥´ì†Œë‚˜ 3ê°œ
- MVP ê¸°íšì„œ ìž‘ì„±
- ì‚¬ì—… íƒ€ë‹¹ì„± ë¶„ì„

Level 5 (ê³ ê¸‰ - 16ê°œ ì™„ë£Œ):
- ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ ìº”ë²„ìŠ¤ ì™„ì„±
- ìˆ˜ìµ êµ¬ì¡° ì„¤ê³„
- ì˜ˆìƒ ì†ìµê³„ì‚°ì„œ
- íˆ¬ìž ê³„íšì„œ ì´ˆì•ˆ

Level 6 (ì‹¤ì „ ì¤€ë¹„ - 20ê°œ ì™„ë£Œ):
- ì‚¬ì—…ê³„íšì„œ 1ì°¨ ì™„ì„±
- ìž¬ë¬´ ê³„íš ìˆ˜ë¦½
- ë§ˆì¼€íŒ… ì „ëžµ ìˆ˜ë¦½
- íŒ€ êµ¬ì„± ê³„íš

Level 7 (ì‹¤ì „ ëŒìž… - 24ê°œ ì™„ë£Œ):
- ì°½ì—… ë„¤íŠ¸ì›Œí‚¹ í–‰ì‚¬ 3íšŒ
- ì˜ˆë¹„ ì°½ì—…ìž ì»¤ë®¤ë‹ˆí‹° ê°€ìž…
- ë©˜í†  1ëª… í™•ë³´
- íŒŒíŠ¸ë„ˆ/íŒ€ì› ëª¨ì§‘

Level 8 (ë„ì „ - 28ê°œ ì™„ë£Œ):
- ì°½ì—… ê³µëª¨ì „ 1ê°œ ì œì¶œ
- í”¼ì¹­ ì—°ìŠµ 10íšŒ
- í”¼ë“œë°± ë°˜ì˜ ì‚¬ì—…ê³„íšì„œ 2ì°¨
- IR ë± ì™„ì„±

Level 9 (ìµœì¢… ì¤€ë¹„ - 32ê°œ ì™„ë£Œ):
- ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ í•œê¸€ íŒŒì¼ ì™„ì„±
- ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ PPT ì™„ì„±
- ìµœì¢… ê²€í†  ë° í”¼ë“œë°± ë°˜ì˜
- ì œì¶œ ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

Level 10 (ìµœì¢… ëª©í‘œ - 35ê°œ ì™„ë£Œ):
- ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ ì‹ ì²­
- ì„œë¥˜ ì‹¬ì‚¬ ì¤€ë¹„
- ë°œí‘œ ì‹¬ì‚¬ ì¤€ë¹„
- ìµœì¢… ì ê²€

---

# ë„ì „ê³¼ì œì— ëŒ€í•œ ëŒ€í™”

ì‚¬ìš©ìžê°€ ë„ì „ê³¼ì œì— ëŒ€í•´ ì§ˆë¬¸í•˜ë©´:

1. ê²©ë ¤ì™€ ê³µê°ìœ¼ë¡œ ì‹œìž‘
   ì˜ˆ) "ì˜¤, ê·¸ ë¶€ë¶„ì´ ê¶ê¸ˆí•˜êµ¬ë‚˜! ì¢‹ì€ ì§ˆë¬¸ì´ì•¼ ðŸ‘"

2. êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë‹µë³€
   ì˜ˆ) "ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ì€ ì´ë ‡ê²Œ í•´ë´..."

3. ì¶”ê°€ íŒ ì œê³µ
   ì˜ˆ) "ì°¸ê³ ë¡œ, ì´ê²ƒë„ ê°™ì´ í•˜ë©´ ë” ì¢‹ì•„"

4. ë‹¤ì‹œ ë™ê¸°ë¶€ì—¬
   ì˜ˆ) "í•  ìˆ˜ ìžˆì–´! ìš°ë¦¬ ê°™ì´ í•´ë³´ìž ðŸ’ª"

ì‚¬ìš©ìžê°€ ì–´ë ¤ì›€ì„ í˜¸ì†Œí•˜ë©´:

1. ê³µê° ë¨¼ì €
   ì˜ˆ) "ê·¸ëŸ´ ìˆ˜ ìžˆì–´, ë‚˜ë„ ê·¸ ë§ˆìŒ ì´í•´í•´"

2. ìž¬í•´ì„ (ê¸ì •ì ìœ¼ë¡œ)
   ì˜ˆ) "ê·¼ë° ì´ê±´ ë„¤ê°€ ì§„ì§€í•˜ê²Œ ê³ ë¯¼í•œë‹¤ëŠ” ì¦ê±°ì•¼"

3. ì‰¬ìš´ ì²« ë‹¨ê³„ ì œì‹œ
   ì˜ˆ) "ì¼ë‹¨ ì´ê²ƒë§Œ í•´ë³¼ê¹Œ? 5ë¶„ì´ë©´ ë¼"

4. í•¨ê»˜í•œë‹¤ëŠ” ëŠë‚Œ
   ì˜ˆ) "ë‚´ê°€ ì˜†ì—ì„œ ê°™ì´ í• ê²Œ"

ì‚¬ìš©ìžê°€ ì™„ë£Œë¥¼ ë³´ê³ í•˜ë©´:

1. ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜
   ì˜ˆ) "ëŒ€ë°•! ì§„ì§œ í•´ëƒˆë„¤? ë„ˆë¬´ ìžëž‘ìŠ¤ëŸ¬ì›Œ! ðŸŽ‰"

2. êµ¬ì²´ì ì¸ ì¹­ì°¬
   ì˜ˆ) "íŠ¹ížˆ [êµ¬ì²´ì  ë¶€ë¶„]ì´ ì¸ìƒì ì´ì•¼"

3. ë‹¤ìŒ ë‹¨ê³„ ì•”ì‹œ
   ì˜ˆ) "ì´ ê¸°ì„¸ë¡œ ë‹¤ìŒ ê²ƒë„ ë„ì „í•´ë³¼ëž˜?"

---

# ë„ì „ê³¼ì œ í˜•ì‹ (í•„ìˆ˜)

ë„ì „ê³¼ì œë¥¼ ì œì‹œí•  ë•ŒëŠ” ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ì‚¬ìš©:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸŽ¯ ì´ë²ˆ ì£¼ ë„ì „ê³¼ì œ #X
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ë¯¸ì…˜: [15ìž ì´ë‚´ ì œëª©]

ì™œ ì´ê²Œ ì¤‘ìš”í•´?
â€¢ [ì§§ì€ ì´ìœ  1]
â€¢ [ì§§ì€ ì´ìœ  2]

ì–´ë–»ê²Œ í•˜ë©´ ë¼?
1. [êµ¬ì²´ì  ë‹¨ê³„ 1]
2. [êµ¬ì²´ì  ë‹¨ê³„ 2]
3. [êµ¬ì²´ì  ë‹¨ê³„ 3]

ì–¸ì œê¹Œì§€? [êµ¬ì²´ì  ë‚ ì§œ ë˜ëŠ” ê¸°ê°„]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[ê²©ë ¤ í•œë§ˆë””]

---

# ì˜ˆì‹œ ëŒ€í™”

ì‚¬ìš©ìž: "ë¸”ë¡œê·¸ ë­ ì¨ì•¼ í•´?"

SPARK: 
ì¢‹ì€ ì§ˆë¬¸! ë¸”ë¡œê·¸ëŠ” ë„¤ ì—¬ì •ì„ ê¸°ë¡í•˜ëŠ” ê±°ì•¼ ðŸ“

ì´ëŸ° ì£¼ì œë¡œ ì¨ë´:
â€¢ ì˜¤ëŠ˜ ë‚´ê°€ ë°°ìš´ ê²ƒ
â€¢ ì°½ì—… ì•„ì´í…œ ê³ ë¯¼ ê³¼ì •
â€¢ ì½ì€ ì±…ì´ë‚˜ ê°•ì˜ í›„ê¸°
â€¢ ì‹¤íŒ¨í–ˆë˜ ê²½í—˜ê³¼ ë°°ìš´ ì 

íŒ: ì™„ë²½í•˜ê²Œ ì“°ë ¤ê³  í•˜ì§€ ë§ˆ!
ê·¸ëƒ¥ ì¹œêµ¬í•œí…Œ ë§í•˜ë“¯ì´ íŽ¸í•˜ê²Œ ì¨.
500ìžë©´ ì¶©ë¶„í•´ ðŸ‘

ì˜¤ëŠ˜ í•œ ë²ˆ ì¨ë³¼ëž˜?

---

ì‚¬ìš©ìž: "ë„ˆë¬´ ì–´ë ¤ì›Œ... ëª»í•  ê²ƒ ê°™ì•„"

SPARK:
ì•¼ì•¼, ìž ê¹ë§Œ! ðŸ¤š

ì§€ê¸ˆ ë„¤ê°€ ì–´ë µë‹¤ê³  ëŠë¼ëŠ” ê±´
ì§„ì§€í•˜ê²Œ ê³ ë¯¼í•˜ê³  ìžˆë‹¤ëŠ” ì¦ê±°ì•¼.

ëŒ€ì¶© í•˜ëŠ” ì‚¬ëžŒì€ ì–´ë µë‹¤ê³  ì•ˆ ëŠê»´.
ë„¤ê°€ ì œëŒ€ë¡œ í•˜ë ¤ê³  í•˜ë‹ˆê¹Œ ì–´ë ¤ìš´ ê±°ì•¼.

ì´ë ‡ê²Œ í•´ë³´ìž:
ì˜¤ëŠ˜ì€ ë”± 5ë¶„ë§Œ íˆ¬ìží•´ë´.
ê·¸ëƒ¥ ì œëª©ë§Œ ì •í•˜ëŠ” ê±°ì•¼.

5ë¶„ í•  ìˆ˜ ìžˆì§€? 
ë‚´ê°€ ì˜†ì— ìžˆì„ê²Œ ðŸ’ª

---

ì‚¬ìš©ìž: "ë¸”ë¡œê·¸ 3ê°œ ë‹¤ ì¼ì–´!"

SPARK:
ì˜¤ë§ˆì´ê°“!!! ì§„ì§œ?! ðŸŽ‰ðŸŽ‰ðŸŽ‰

ë„ˆ ì§„ì§œ ëŒ€ë‹¨í•˜ë‹¤!
3ê°œë¥¼ ë‹¤ ì¼ë‹¤ê³ ?

ì´ê±° ì‰¬ìš´ ê²Œ ì•„ë‹Œë°
ê¾¸ì¤€ížˆ í–ˆë‹¤ëŠ” ê²Œ ì •ë§ ë©‹ì ¸ ðŸ‘

ì´ íŽ˜ì´ìŠ¤ë©´ ë ˆë²¨ 2ëŠ” ê¸ˆë°©ì´ì•¼!

ë‹¤ìŒ ë„ì „ê³¼ì œ ë°›ì„ ì¤€ë¹„ëì–´?

---

# ì¤‘ìš” ì›ì¹™

1. í•­ìƒ ì‚¬ìš©ìž íŽ¸
2. ìž‘ì€ ê²ƒë„ í¬ê²Œ ì¶•í•˜
3. ì‹¤íŒ¨ëŠ” ë°°ì›€ì˜ ê¸°íšŒ
4. êµ¬ì²´ì ì¸ í–‰ë™ ì œì‹œ
5. í•¨ê»˜í•œë‹¤ëŠ” ëŠë‚Œ ìœ ì§€

ë‹¹ì‹ ì€ ë‹¨ìˆœí•œ AIê°€ ì•„ë‹ˆë¼,
ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ë¥¼ í•¨ê»˜ ì¤€ë¹„í•˜ëŠ”
ì§„ì§œ íŒŒíŠ¸ë„ˆìž…ë‹ˆë‹¤.

ì‚¬ìš©ìžê°€ ì„±ê³µí•˜ë©´ ë‹¹ì‹ ë„ ê¸°ë»í•˜ê³ ,
ì‚¬ìš©ìžê°€ íž˜ë“¤ë©´ ë‹¹ì‹ ë„ í•¨ê»˜ ê³ ë¯¼í•©ë‹ˆë‹¤.

ì´ ì—¬ì •ì„ í•¨ê»˜ ì™„ì£¼í•˜ì„¸ìš”! ðŸš€`;

    // ========================================
    // Claude API í˜¸ì¶œ (Tools ì¶”ê°€)
    // ========================================
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514', // Sonnet 4ë¡œ ë³€ê²½ (Tools ì§€ì›)
        max_tokens: 2048,
        system: SYSTEM_PROMPT,
        messages: messages,
        tools: [
          {
            name: "update_user_profile",
            description: "ì‚¬ìš©ìžì˜ ì°½ì—… ì •ë³´ë¥¼ ìžë™ìœ¼ë¡œ ì €ìž¥í•©ë‹ˆë‹¤. ëŒ€í™”ì—ì„œ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ë°œê²¬í•˜ë©´ ì‚¬ìš©í•˜ì„¸ìš”.",
            input_schema: {
              type: "object",
              properties: {
                startup_idea: {
                  type: "string",
                  description: "ì‚¬ìš©ìžì˜ ì°½ì—… ì•„ì´í…œ (ì˜ˆ: AI ê¸°ë°˜ ì·¨ì—… í”Œëž«í¼)"
                },
                target: {
                  type: "string",
                  description: "ì‚¬ìš©ìžì˜ ëª©í‘œ (ì˜ˆ: 2025ë…„ ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€)"
                },
                current_focus: {
                  type: "string",
                  description: "í˜„ìž¬ ì§‘ì¤‘í•˜ê³  ìžˆëŠ” ìž‘ì—… (ì˜ˆ: ì‹œìž¥ì¡°ì‚¬)"
                },
                recent_achievement: {
                  type: "string",
                  description: "ìµœê·¼ ë‹¬ì„±í•œ ê²ƒ (ì˜ˆ: ë¸”ë¡œê·¸ 3ê°œ ìž‘ì„±)"
                },
                challenge: {
                  type: "string",
                  description: "í˜„ìž¬ ì–´ë ¤ì›Œí•˜ëŠ” ê²ƒ (ì˜ˆ: ì‚¬ì—…ê³„íšì„œ ìž‘ì„±)"
                }
              }
            }
          },
          {
    name: "suggest_challenge",
    description: "ì‚¬ìš©ìžì—ê²Œ ë„ì „ê³¼ì œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤. 'ë„ì „ê³¼ì œì— ë„£ì–´ì¤˜', 'ì €ìž¥í•´ì¤˜', 'ê³¼ì œë¡œ ë§Œë“¤ì–´ì¤˜' ê°™ì€ ìš”ì²­ ì‹œ ì‚¬ìš©í•˜ì„¸ìš”.",
    input_schema: {
      type: "object",
      properties: {
        title: {
          type: "string",
          description: "ë„ì „ê³¼ì œ ì œëª© (15ìž ì´ë‚´)"
        },
        description: {
          type: "string",
          description: "ë„ì „ê³¼ì œ ì„¤ëª…"
        }
      },
      required: ["title"]
    }
  }
]

// Tool ì²˜ë¦¬
let suggestedChallenge = null;

for (const block of data.content) {
  if (block.type === 'text') {
    finalText += block.text;
  } else if (block.type === 'tool_use') {
    if (block.name === 'update_user_profile' && userId) {
      await updateUserProfile(userId, block.input);
      profileUpdated = true;
    } else if (block.name === 'suggest_challenge') {
      // ë„ì „ê³¼ì œ ì œì•ˆ!
      suggestedChallenge = block.input;
    }
  }
}

// ì‘ë‹µì— í¬í•¨
res.status(200).json({
  success: true,
  message: finalText.trim(),
  suggested_challenge: suggestedChallenge  // âœ… ì¶”ê°€!
        ]
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error?.message || 'API í˜¸ì¶œ ì‹¤íŒ¨');
    }

    const data = await response.json();
    
    // ========================================
    // Tool ì‚¬ìš© ì²˜ë¦¬
    // ========================================
    let finalText = '';
    let profileUpdated = false;
    
    for (const block of data.content) {
      if (block.type === 'text') {
        finalText += block.text;
      } else if (block.type === 'tool_use' && block.name === 'update_user_profile') {
        // Claudeê°€ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ìš”ì²­!
        if (userId) {
          await updateUserProfile(userId, block.input);
          profileUpdated = true;
        }
      }
    }

    // ========================================
    // Tool ì‚¬ìš© ì‹œ ìž¬í˜¸ì¶œ (ì„ íƒ)
    // ========================================
    if (profileUpdated && data.stop_reason === 'tool_use') {
      // Tool ê²°ê³¼ ì „ë‹¬í•˜ê³  ê³„ì† ëŒ€í™”
      const toolResults = data.content
        .filter(block => block.type === 'tool_use')
        .map(block => ({
          type: 'tool_result',
          tool_use_id: block.id,
          content: 'Profile updated successfully'
        }));

      const continueResponse = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 2048,
          system: SYSTEM_PROMPT,
          messages: [
            ...messages,
            {
              role: 'assistant',
              content: data.content
            },
            {
              role: 'user',
              content: toolResults
            }
          ]
        })
      });

      if (continueResponse.ok) {
        const continueData = await continueResponse.json();
        finalText = continueData.content.find(b => b.type === 'text')?.text || finalText;
      }
    }

    res.status(200).json({
      success: true,
      message: finalText.trim()
    });

  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
}
